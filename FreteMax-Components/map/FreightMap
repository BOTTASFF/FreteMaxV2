import React, { useEffect, useState } from 'react';
import { MapContainer, TileLayer, Marker, Popup, Polyline, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import { MapPin, Navigation } from 'lucide-react';
import { Button } from '@/components/ui/button';

// Fix for default marker icons in React-Leaflet
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// Custom icons
const createCustomIcon = (color) => {
  return L.divIcon({
    className: 'custom-marker',
    html: `
      <div style="
        background-color: ${color};
        width: 32px;
        height: 32px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        border: 3px solid white;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
      ">
        <div style="
          width: 12px;
          height: 12px;
          background-color: white;
          border-radius: 50%;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        "></div>
      </div>
    `,
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -32],
  });
};

const pickupIcon = createCustomIcon('#3b82f6'); // Blue
const deliveryIcon = createCustomIcon('#22c55e'); // Green

// Component to fit bounds when coordinates change
function MapUpdater({ pickupCoords, deliveryCoords }) {
  const map = useMap();

  useEffect(() => {
    if (pickupCoords && deliveryCoords) {
      const bounds = L.latLngBounds([pickupCoords, deliveryCoords]);
      map.fitBounds(bounds, { padding: [50, 50] });
    } else if (pickupCoords) {
      map.setView(pickupCoords, 10);
    } else if (deliveryCoords) {
      map.setView(deliveryCoords, 10);
    }
  }, [pickupCoords, deliveryCoords, map]);

  return null;
}

export default function FreightMap({ 
  pickupLocation, 
  deliveryLocation, 
  freight,
  height = "400px",
  showRoute = true 
}) {
  const [pickupCoords, setPickupCoords] = useState(null);
  const [deliveryCoords, setDeliveryCoords] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  // Geocoding function using Nominatim (OpenStreetMap)
  const geocodeLocation = async (location) => {
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}, Brasil&limit=1`
      );
      const data = await response.json();
      if (data && data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      }
      return null;
    } catch (error) {
      console.error('Geocoding error:', error);
      return null;
    }
  };

  useEffect(() => {
    const loadCoordinates = async () => {
      setLoading(true);
      setError(null);

      try {
        const [pickup, delivery] = await Promise.all([
          pickupLocation ? geocodeLocation(pickupLocation) : null,
          deliveryLocation ? geocodeLocation(deliveryLocation) : null,
        ]);

        if (!pickup && !delivery) {
          setError('Não foi possível localizar os endereços no mapa');
        }

        setPickupCoords(pickup);
        setDeliveryCoords(delivery);
      } catch (err) {
        setError('Erro ao carregar o mapa');
      } finally {
        setLoading(false);
      }
    };

    loadCoordinates();
  }, [pickupLocation, deliveryLocation]);

  const openInWaze = (coords, address, type) => {
    if (coords) {
      const [lat, lon] = coords;
      const wazeUrl = `https://waze.com/ul?ll=${lat},${lon}&navigate=yes&z=10`;
      window.open(wazeUrl, '_blank');
    }
  };

  const openInGoogleMaps = (coords, address) => {
    if (coords) {
      const [lat, lon] = coords;
      const googleUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
      window.open(googleUrl, '_blank');
    }
  };

  if (loading) {
    return (
      <div 
        className="flex items-center justify-center bg-slate-100 rounded-xl"
        style={{ height }}
      >
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3" />
          <p className="text-slate-600">Carregando mapa...</p>
        </div>
      </div>
    );
  }

  if (error || (!pickupCoords && !deliveryCoords)) {
    return (
      <div 
        className="flex items-center justify-center bg-slate-100 rounded-xl"
        style={{ height }}
      >
        <div className="text-center text-slate-600">
          <MapPin className="w-12 h-12 mx-auto mb-3 text-slate-400" />
          <p>{error || 'Localização não disponível'}</p>
        </div>
      </div>
    );
  }

  const center = pickupCoords || deliveryCoords || [-15.7942, -47.8822]; // Default: Brasília

  return (
    <div className="space-y-3">
      {/* Navigation Buttons */}
      <div className="flex gap-2 flex-wrap">
        {pickupCoords && (
          <>
            <Button
              onClick={() => openInWaze(pickupCoords, pickupLocation, 'pickup')}
              className="bg-[#33CCFF] hover:bg-[#2BB8E8] text-white gap-2 flex-1 sm:flex-none"
            >
              <Navigation className="w-4 h-4" />
              Coleta no Waze
            </Button>
            <Button
              onClick={() => openInGoogleMaps(pickupCoords, pickupLocation)}
              variant="outline"
              className="gap-2 flex-1 sm:flex-none"
            >
              <MapPin className="w-4 h-4" />
              Coleta no Google Maps
            </Button>
          </>
        )}
        {deliveryCoords && (
          <>
            <Button
              onClick={() => openInWaze(deliveryCoords, deliveryLocation, 'delivery')}
              className="bg-[#33CCFF] hover:bg-[#2BB8E8] text-white gap-2 flex-1 sm:flex-none"
            >
              <Navigation className="w-4 h-4" />
              Entrega no Waze
            </Button>
            <Button
              onClick={() => openInGoogleMaps(deliveryCoords, deliveryLocation)}
              variant="outline"
              className="gap-2 flex-1 sm:flex-none"
            >
              <MapPin className="w-4 h-4" />
              Entrega no Google Maps
            </Button>
          </>
        )}
      </div>

      {/* Map */}
      <div className="relative rounded-xl overflow-hidden border-2 border-slate-200 shadow-lg" style={{ height }}>
        <MapContainer
          center={center}
          zoom={6}
          style={{ height: '100%', width: '100%' }}
          scrollWheelZoom={false}
        >
          <TileLayer
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          />

          <MapUpdater pickupCoords={pickupCoords} deliveryCoords={deliveryCoords} />

          {/* Pickup Marker */}
          {pickupCoords && (
            <Marker position={pickupCoords} icon={pickupIcon}>
              <Popup>
                <div className="p-2">
                  <div className="flex items-center gap-2 mb-2">
                    <MapPin className="w-4 h-4 text-blue-600" />
                    <strong className="text-blue-600">Local de Coleta</strong>
                  </div>
                  <p className="text-sm text-slate-700">{pickupLocation}</p>
                  {freight && (
                    <p className="text-xs text-slate-500 mt-1">
                      {freight.cargo_name}
                    </p>
                  )}
                </div>
              </Popup>
            </Marker>
          )}

          {/* Delivery Marker */}
          {deliveryCoords && (
            <Marker position={deliveryCoords} icon={deliveryIcon}>
              <Popup>
                <div className="p-2">
                  <div className="flex items-center gap-2 mb-2">
                    <MapPin className="w-4 h-4 text-green-600" />
                    <strong className="text-green-600">Local de Entrega</strong>
                  </div>
                  <p className="text-sm text-slate-700">{deliveryLocation}</p>
                  {freight && (
                    <p className="text-xs text-slate-500 mt-1">
                      Valor: {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(freight.freight_value)}
                    </p>
                  )}
                </div>
              </Popup>
            </Marker>
          )}

          {/* Route Line */}
          {showRoute && pickupCoords && deliveryCoords && (
            <Polyline
              positions={[pickupCoords, deliveryCoords]}
              color="#3b82f6"
              weight={3}
              opacity={0.7}
              dashArray="10, 10"
            />
          )}
        </MapContainer>

        {/* Legend */}
        <div className="absolute bottom-4 right-4 bg-white rounded-lg shadow-lg p-3 z-[1000]">
          <div className="space-y-2 text-xs">
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-blue-600"></div>
              <span className="text-slate-700">Coleta</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-3 h-3 rounded-full bg-green-600"></div>
              <span className="text-slate-700">Entrega</span>
            </div>
            {showRoute && pickupCoords && deliveryCoords && (
              <div className="flex items-center gap-2">
                <Navigation className="w-3 h-3 text-blue-600" />
                <span className="text-slate-700">Rota</span>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}
