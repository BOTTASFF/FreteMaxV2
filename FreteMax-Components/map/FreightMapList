import React, { useEffect, useState } from 'react';
import { MapContainer, TileLayer, Marker, Popup, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import { MapPin, DollarSign, Calendar, Building2, User } from 'lucide-react';
import { format } from 'date-fns';

// Fix for default marker icons
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// Create numbered markers with different colors based on status
const createNumberedIcon = (number, status) => {
  const colors = {
    available: '#3b82f6',
    assigned: '#f59e0b',
    in_transit: '#8b5cf6',
    delivered: '#22c55e',
    cancelled: '#ef4444'
  };
  
  const color = colors[status] || '#6b7280';
  
  return L.divIcon({
    className: 'custom-numbered-marker',
    html: `
      <div style="
        background-color: ${color};
        width: 36px;
        height: 36px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        border: 3px solid white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
      ">
        <span style="
          transform: rotate(45deg);
          color: white;
          font-weight: bold;
          font-size: 14px;
        ">${number}</span>
      </div>
    `,
    iconSize: [36, 36],
    iconAnchor: [18, 36],
    popupAnchor: [0, -36],
  });
};

function MapUpdater({ freightsWithCoords }) {
  const map = useMap();

  useEffect(() => {
    if (freightsWithCoords.length > 0) {
      const bounds = L.latLngBounds(
        freightsWithCoords
          .filter(f => f.pickupCoords)
          .map(f => f.pickupCoords)
      );
      
      if (bounds.isValid()) {
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 12 });
      }
    }
  }, [freightsWithCoords, map]);

  return null;
}

export default function FreightMapList({ 
  freights = [], 
  height = "600px",
  onFreightClick 
}) {
  const [freightsWithCoords, setFreightsWithCoords] = useState([]);
  const [loading, setLoading] = useState(true);

  const geocodeLocation = async (location) => {
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}, Brasil&limit=1`
      );
      const data = await response.json();
      if (data && data.length > 0) {
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      }
      return null;
    } catch (error) {
      console.error('Geocoding error:', error);
      return null;
    }
  };

  useEffect(() => {
    const loadAllCoordinates = async () => {
      setLoading(true);
      
      const freightsWithCoordsPromises = freights.map(async (freight, index) => {
        const pickupCoords = await geocodeLocation(freight.pickup_location);
        const deliveryCoords = await geocodeLocation(freight.delivery_location);
        
        return {
          ...freight,
          index: index + 1,
          pickupCoords,
          deliveryCoords
        };
      });

      const results = await Promise.all(freightsWithCoordsPromises);
      setFreightsWithCoords(results.filter(f => f.pickupCoords));
      setLoading(false);
    };

    if (freights.length > 0) {
      loadAllCoordinates();
    } else {
      setLoading(false);
    }
  }, [freights]);

  if (loading) {
    return (
      <div 
        className="flex items-center justify-center bg-slate-100 rounded-xl"
        style={{ height }}
      >
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-3" />
          <p className="text-slate-600">Carregando mapa...</p>
          <p className="text-xs text-slate-500 mt-1">Geocodificando {freights.length} locais</p>
        </div>
      </div>
    );
  }

  if (freightsWithCoords.length === 0) {
    return (
      <div 
        className="flex items-center justify-center bg-slate-100 rounded-xl"
        style={{ height }}
      >
        <div className="text-center text-slate-600">
          <MapPin className="w-12 h-12 mx-auto mb-3 text-slate-400" />
          <p>Nenhum frete para exibir no mapa</p>
        </div>
      </div>
    );
  }

  const center = freightsWithCoords[0]?.pickupCoords || [-15.7942, -47.8822];

  return (
    <div className="relative rounded-xl overflow-hidden border-2 border-slate-200 shadow-lg" style={{ height }}>
      <MapContainer
        center={center}
        zoom={6}
        style={{ height: '100%', width: '100%' }}
        scrollWheelZoom={true}
      >
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        />

        <MapUpdater freightsWithCoords={freightsWithCoords} />

        {freightsWithCoords.map((freight) => (
          <React.Fragment key={freight.id}>
            {/* Pickup Marker */}
            {freight.pickupCoords && (
              <Marker 
                position={freight.pickupCoords} 
                icon={createNumberedIcon(freight.index, freight.status)}
                eventHandlers={{
                  click: () => onFreightClick && onFreightClick(freight)
                }}
              >
                <Popup maxWidth={300}>
                  <div className="p-3">
                    <div className="flex items-start justify-between mb-3">
                      <h3 className="font-bold text-slate-900">{freight.cargo_name}</h3>
                      <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                        #{freight.index}
                      </span>
                    </div>

                    <div className="space-y-2 text-sm">
                      <div className="flex items-center gap-2 text-slate-600">
                        <MapPin className="w-4 h-4 text-blue-600" />
                        <div>
                          <p className="font-medium text-blue-600">Coleta</p>
                          <p>{freight.pickup_location}</p>
                        </div>
                      </div>

                      <div className="flex items-center gap-2 text-slate-600">
                        <MapPin className="w-4 h-4 text-green-600" />
                        <div>
                          <p className="font-medium text-green-600">Entrega</p>
                          <p>{freight.delivery_location}</p>
                        </div>
                      </div>

                      <div className="flex items-center gap-2 text-slate-600">
                        <DollarSign className="w-4 h-4 text-green-600" />
                        <span className="font-bold text-green-600">
                          {new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(freight.freight_value)}
                        </span>
                      </div>

                      <div className="flex items-center gap-2 text-slate-600">
                        <Calendar className="w-4 h-4" />
                        <span>Até {format(new Date(freight.pickup_deadline), 'dd/MM/yyyy')}</span>
                      </div>

                      {freight.company_name && (
                        <div className="flex items-center gap-2 text-slate-600">
                          <Building2 className="w-4 h-4" />
                          <span>{freight.company_name}</span>
                        </div>
                      )}

                      {freight.driver_name && (
                        <div className="flex items-center gap-2 text-slate-600">
                          <User className="w-4 h-4" />
                          <span>{freight.driver_name}</span>
                        </div>
                      )}
                    </div>

                    {onFreightClick && (
                      <button
                        onClick={() => onFreightClick(freight)}
                        className="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-sm font-medium transition-colors"
                      >
                        Ver Detalhes
                      </button>
                    )}
                  </div>
                </Popup>
              </Marker>
            )}
          </React.Fragment>
        ))}
      </MapContainer>

      {/* Status Legend */}
      <div className="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-3 z-[1000]">
        <p className="text-xs font-semibold text-slate-700 mb-2">Status</p>
        <div className="space-y-1 text-xs">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-blue-600"></div>
            <span className="text-slate-700">Disponível</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-yellow-600"></div>
            <span className="text-slate-700">Atribuído</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-purple-600"></div>
            <span className="text-slate-700">Em Trânsito</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 rounded-full bg-green-600"></div>
            <span className="text-slate-700">Entregue</span>
          </div>
        </div>
      </div>

      {/* Counter */}
      <div className="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg px-4 py-2 z-[1000]">
        <p className="text-sm font-medium text-slate-700">
          {freightsWithCoords.length} {freightsWithCoords.length === 1 ? 'frete' : 'fretes'} no mapa
        </p>
      </div>
    </div>
  );
}
